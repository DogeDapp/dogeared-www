function dogeared_init(){$("a").click(function(){$(this);if(!dogeared_network_is_online()){dogeared_feedback("The internet says NO.");return false}});dogeared_network_init();dogeared_cache_highlights_init()}function dogeared_abs_root_url(){return document.body.getAttribute("data-abs-root-url")}function dogeared_on_online(){dogeared_feedback("You appear to be online again.");console.log("online")}function dogeared_on_offline(){dogeared_feedback("You appear to be offline.");console.log("offline")};function dogeared_network_init(){window.addEventListener("offline",dogeared_network_on_offline);window.addEventListener("online",dogeared_network_on_online);dogeared_network_status()}function dogeared_network_is_online(){return navigator.onLine}function dogeared_network_on_online(a){console.log("came back online at "+a.timeStamp);dogeared_network_status();$(".btn-save-highlight").removeAttr("disabled")}
function dogeared_network_on_offline(a){console.log("went offline at "+a.timeStamp);dogeared_network_status();$(".btn-save-highlight").attr("disabled","disabled")}function dogeared_network_status(){var a=$("#feedback-network-status");dogeared_network_is_online()?a.html("you are awake and connected to the network"):a.html("you are playing hide-and-go-seek with the sky and the sky is winning.")};var de_feedback_timeout=null;function dogeared_feedback_ok(a,b){dogeared_feedback(a);b||(b=10);b*=1E3;de_feedback_timeout&&clearTimeout(de_feedback_timeout);de_feedback_timeout=setTimeout(function(){dogeared_feedback_reset()},b)}function dogeared_feedback_error(a){dogeared_feedback(a)}function dogeared_feedback(a){$("#feedback-general").html(a)}function dogeared_feedback_reset(){$("#feedback-general").html("")};function dogeared_api_call(a,b,c,e){var h=dogeared_api_endpoint();b.method=a;if(!b.access_token)if(a=dogeared_api_site_token())b.access_token=a;$.ajax({url:h,type:"POST",data:b,dataType:"json",success:function(f){c&&c(f)},error:function(f){if(f=function(j){if(j.responseText)try{return j=JSON.parse(j.responseText)}catch(l){console.log("Failed to parse response text");dogeared_feedback_error("The API is full of crazy-talk: Failed to parse response text")}else{console.log("Missing response text");dogeared_feedback_error("The API is full of crazy-talk: Missing response text")}}(f))f.error?
dogeared_feedback_error("The API is sad: "+f.error.message):dogeared_feedback(f);e&&e(f)}})}function dogeared_api_endpoint(){return document.body.getAttribute("data-api-endpoint")}function dogeared_api_site_token(){return document.body.getAttribute("data-api-site-token")};function dogeared_documents_init(){window.addEventListener("offline",function(a){dogeared_documents_on_offline(a)});window.addEventListener("online",function(a){dogeared_documents_on_online(a)});$("#dogeared-navi li a").click(function(){if(!dogeared_network_is_online()){$(this).html()=="reading list"&&dogeared_documents_load_cache();return false}});$(".delete-document").click(function(){if(!confirm("Are you sure you want to remove this document?"))return false;var a=$(this).attr("data-document-id");
dogeared_api_call("dogeared.readinglists.deleteDocument",{document_id:a},function(){$("#document-"+a).remove();dogeared_feedback("Okay, that document has been removed from your reading list")})});dogeared_network_is_online()?dogeared_documents_fill_cache():dogeared_documents_load_cache()}function dogeared_documents_on_online(){console.log("local: online");$(".delete-document").removeAttr("disabled")}
function dogeared_documents_on_offline(){console.log("local: offline");$(".delete-document").attr("disabled","disabled");dogeared_documents_load_cache()}
function dogeared_documents_load_cache(){console.log("load cache");var a=dogeared_cache_documents(),b=a.length;if(b==0)return false;a.reverse();$(".excerpt").remove();$(".document").remove();var c=$("#documents"),e={};dogeared_abs_root_url();for(var h=0;h<b;h++){var f=a[h],j=f.id,l=f.title?f.title:f.url;e[j]=h;var d='<div class="row excerpt">';d+='<h3><a href="#';d+='" class="load-doc" data-document-id="';d+=htmlspecialchars(j);d+='">';d+=htmlspecialchars(l);d+="</a>";d+=" <small>offline cache</small>";
d+="</h3>";d+="<p>";d+=htmlspecialchars(f.excerpt);d+=' <a href="#" class="load-doc" data-document-id="';d+=htmlspecialchars(j);d+='">...</a></p>';d+="</div>";c.append(d)}$(".load-doc").click(function(){var m=$(this).attr("data-document-id"),k=a[e[m]],n=k.title?k.title:k.url;k=JSON.parse(k.body);var g='<div class="row document"';g+=' data-document-id="';g+=htmlspecialchars(m);g+='">';g+="<h3>";g+=htmlspecialchars(n);g+="<small>offline cache</small>";g+="</h3>";for(var o in k){g+="<p>";g+=htmlspecialchars(k[o]);
g+="</p>"}g+="</document>";$(".excerpt").remove();c.append(g);return false});dogeared_document_init()}function dogeared_documents_get_text(a){a=a.document_id;if(a=="0")return false;dogeared_api_call("dogeared.documents.getInfo",{document_id:a},function(b){dogeared_cache_documents_store(b.document)})}function dogeared_documents_store_docs(a){for(i in a)dogeared_documents_get_text(a[i])}
function dogeared_documents_fill_cache(){dogeared_api_call("dogeared.readinglists.getDocuments",{},function(a){dogeared_documents_store_docs(a.documents.document)})};var current_selection="";
function dogeared_document_init(){typeof window.ontouchend=="object"?$(document).bind("selectionchange",dogeared_document_selected_selectionchange):$(document).bind("mouseup",dogeared_document_selected_mouseup);$(".delete-document").click(function(){if(!confirm("Are you sure you want to remove this document?"))return false;var a={document_id:$(this).attr("data-document-id")};dogeared_api_call("dogeared.readinglists.deleteDocument",a,function(){var b=dogeared_abs_root_url()+"documents/?deleted=1";
location.href=b})})}
function dogeared_document_selected_mouseup(a){console.log("on mouseup");if(a.target.nodeName=="BUTTON")dogeared_document_add_highlight();else{$(".highlight").remove();a=window.getSelection();if(a.toString()!=""){range=window.getSelection().getRangeAt(0);expandedSelRange=range.cloneRange();range.collapse(false);var b=document.createElement("div");b.innerHTML='<span class="highlight"> <button id="highlight" class="btn btn-sm">Highlight</button> </span>';for(var c=document.createDocumentFragment(),e,
h;e=b.firstChild;)h=c.appendChild(e);range.insertNode(c);if(h){expandedSelRange.setEndAfter(h.previousSibling);a.removeAllRanges();a.addRange(expandedSelRange)}}}}
function dogeared_document_selected_selectionchange(){console.log("on selectionchange");$(".highlight").remove();var a=window.getSelection().toString();if(a!="")if(a!=current_selection){current_selection=a;range=window.getSelection().getRangeAt(0);expandedSelRange=range.cloneRange();range.collapse(false);a=document.createElement("div");a.innerHTML='<span class="highlight"> <button id="highlight" class="btn btn-sm">Highlight</button> </span>';for(var b=document.createDocumentFragment(),c;c=a.firstChild;)b.appendChild(c);
range.insertNode(b);$("#highlight").click(dogeared_document_add_highlight)}}
function dogeared_document_add_highlight(){var a=$("#document").attr("data-document-id"),b=window.getSelection();b=current_selection?current_selection:b.toString();a={document_id:a,text:b};if(dogeared_network_is_online())dogeared_api_call("dogeared.highlights.addHighlight",a,function(c){c.stat!="ok"?dogeared_feedback_api_error(c):dogeared_feedback("Your highlight has been added.")});else if(dogeared_cache_highlights_store(a)){dogeared_feedback("Your highlight has been cached until..");dogeared_cache_highlights_status()}}
;function dogeared_highlights_init(){}function dogeared_highlights_init_list(){$(".delete-highlight").click(function(){if(!confirm("Are you sure you want to delete this highlight?"))return false;var a=$(this).attr("data-highlight-id");dogeared_api_call("dogeared.highlights.deleteHighlight",{id:a},function(){$("#highlight-"+a).remove();dogeared_feedback("That highlight has been deleted.")})})}
function dogeared_highlights_init_single(){$(".delete-highlight").click(function(){if(!confirm("Are you sure you want to delete this highlight?"))return false;var a={id:$(this).attr("data-highlight-id")};dogeared_api_call("dogeared.highlights.deleteHighlight",a,function(){var b=dogeared_abs_root_url()+"highlights/?deleted=1";location.href=b})})};function dogeared_cache_count_for_type(a){var b=0;store.forEach(function(c){if(c.split("_")[0]==a)b+=1});return b}function dogeared_cache_get_for_type(a){var b=[];store.forEach(function(c,e){if(c.split("_")[0]==a){e.cache_key=c;b.push(e)}});return b};function dogeared_cache_documents_store(a){if(!store.enabled){console.log("localstorage is not enabled");return false}var b=a.lastmodified,c="dogeared_"+a.id,e=1;if(cache=store.get(c))if(cache.lastmodified>=b)e=0;e&&store.set(c,a)}function dogeared_cache_documents(){return dogeared_cache_get_for_type("dogeared")};function dogeared_cache_highlights_init(){dogeared_cache_highlights_status()}function dogeared_cache_highlights_store(a){if(!store.enabled){console.log("localstorage is not enabled");return false}var b=hex_md5(a.text);a.hash=b;b="highlight_"+b;if(cache=store.get(b))return true;store.set(b,a);return true}function dogeared_cache_highlights_remove_key(a){store.remove(a)}
function dogeared_cache_highlights_status(){var a=$("#feedback-pending-highlights"),b=dogeared_cache_count_for_type("highlight");if(b==1){var c=dogeared_abs_root_url()+"highlights/pending/";a.html('there are <a href="'+c+'">pending highlights</a>.');a.show()}else if(b){c=dogeared_abs_root_url()+"highlights/pending/";a.html('there are <a href="'+c+'">'+b+" pending highlights</a>.");a.show()}else{a.html("");a.hide()}}
function dogeared_cache_highlights(){return dogeared_cache_get_for_type("highlight")};
