function dogeared_init(){window.addEventListener("offline",dogeared_on_offline);window.addEventListener("online",dogeared_on_online);dogeared_network_init();dogeared_appcache_init();dogeared_cache_highlights_init()}function dogeared_abs_root_url(){return document.body.getAttribute("data-abs-root-url")}function dogeared_now(){var a=(new Date).getTime();return a=parseInt(a/1E3)}
function dogeared_on_online(a){console.log("came online at "+a.timeStamp);dogeared_feedback("You appear to be online again.");$(".appcache_equals_no").show()}function dogeared_on_offline(a){console.log("went offline at "+a.timeStamp);dogeared_feedback("You appear to be offline.");$(".appcache_equals_no").hide()};function dogeared_network_init(){window.addEventListener("offline",dogeared_network_on_offline);window.addEventListener("online",dogeared_network_on_online);dogeared_network_status()}function dogeared_network_is_online(){return navigator.onLine}function dogeared_network_on_online(){dogeared_network_status();$(".btn-save-highlight").removeAttr("disabled")}function dogeared_network_on_offline(){dogeared_network_status();$(".btn-save-highlight").attr("disabled","disabled")}
function dogeared_network_status(){var a=$("#feedback-network-status");dogeared_network_is_online()?a.html("you are awake and connected to the network"):a.html("you are playing hide-and-go-seek with the sky and the sky is winning.")};function dogeared_appcache_init(){window.applicationCache.addEventListener("cached",dogeared_appcache_on_event,false);window.applicationCache.addEventListener("checking",dogeared_appcache_on_event,false);window.applicationCache.addEventListener("downloading",dogeared_appcache_on_event,false);window.applicationCache.addEventListener("error",dogeared_appcache_on_error,false);window.applicationCache.addEventListener("noupdate",dogeared_appcache_on_event,false);window.applicationCache.addEventListener("obsolete",
dogeared_appcache_on_event,false);window.applicationCache.addEventListener("progress",dogeared_appcache_on_event,false);window.applicationCache.addEventListener("updateready",dogeared_appcache_on_updateready,false)}function dogeared_appcache_on_event(a){a=a.type;console.log("appcache event "+a);a=="progress"?dogeared_feedback("checking for updates"):dogeared_feedback_reset()}function dogeared_appcache_on_error(a){console.log("appcache error");console.log(a)}
function dogeared_appcache_on_updateready(){window.applicationCache.status==window.applicationCache.UPDATEREADY&&confirm("An updated version of site is available. Load it?")&&window.location.reload()}function dogeared_appcache_status_code(){return window.applicationCache.status}
function dogeared_appcache_status(){switch(dogeared_appcache_status_code()){case window.applicationCache.UNCACHED:return"UNCACHED";case window.applicationCache.IDLE:return"IDLE";case window.applicationCache.CHECKING:return"CHECKING";case window.applicationCache.DOWNLOADING:return"DOWNLOADING";case window.applicationCache.UPDATEREADY:return"UPDATEREADY";case window.applicationCache.OBSOLETE:return"OBSOLETE";default:return"UKNOWN CACHE STATUS"}};var de_feedback_timeout=null;function dogeared_feedback_ok(a,b){dogeared_feedback(a);b||(b=10);b*=1E3;de_feedback_timeout&&clearTimeout(de_feedback_timeout);de_feedback_timeout=setTimeout(function(){dogeared_feedback_reset()},b)}function dogeared_feedback_error(a){dogeared_feedback(a)}function dogeared_feedback_api_error(a){dogeared_feeback_error(a.error.message);alert(msg)}function dogeared_feedback_modal(a){dogeared_feedback_ok(a,10);alert(a)}
function dogeared_feedback(a){$("#feedback-general").html(a)}function dogeared_feedback_reset(){$("#feedback-general").html("")};function dogeared_api_call(a,b,c,d){var e=dogeared_api_endpoint();b.method=a;if(!b.access_token)if(a=dogeared_api_site_token())b.access_token=a;$.ajax({url:e,type:"POST",data:b,dataType:"json",success:function(f){c&&c(f)},error:function(f){if(f=function(j){if(j.responseText)try{return j=JSON.parse(j.responseText)}catch(l){console.log("Failed to parse response text");dogeared_feedback_error("The API is full of crazy-talk: Failed to parse response text")}else{console.log("Missing response text");dogeared_feedback_error("The API is full of crazy-talk: Missing response text")}}(f))f.error?
dogeared_feedback_error("The API is sad: "+f.error.message):dogeared_feedback(f);d&&d(f)}})}function dogeared_api_endpoint(){return document.body.getAttribute("data-api-endpoint")}function dogeared_api_site_token(){return document.body.getAttribute("data-api-site-token")};function dogeared_extruder_init(){window.addEventListener("offline",function(a){dogeared_extruder_on_offline(a)});window.addEventListener("online",function(a){dogeared_extruder_on_online(a)});$("#fetch").submit(function(){var a=$("#url");a=a.val();dogeared_api_call("dogeared.documents.addDocument",{url:a},function(b){var c=b.document.id;c='Okay! <a href="'+(dogeared_abs_root_url()+"documents/"+c+"/")+'">That document</a> is ready to be dogeared.';dogeared_feedback_ok(c,60);$("#button-dogear").removeAttr("disabled");
dogeared_cache_documents_store(b.document)});dogeared_feedback("Fetching your document, now...");$("#button-dogear").attr("disabled","disabled");return false});dogeared_network_is_online()||dogeared_extruder_hide_form()}function dogeared_extruder_on_online(){dogeared_extruder_show_form()}function dogeared_extruder_on_offline(){dogeared_extruder_hide_form()}function dogeared_extruder_show_form(){$("#fetch").show()}function dogeared_extruder_hide_form(){$("#fetch").hide()};function dogeared_documents_init(){window.addEventListener("offline",function(a){dogeared_documents_on_offline(a)});window.addEventListener("online",function(a){dogeared_documents_on_online(a)});$("#dogeared-navi li a").click(function(){if(!dogeared_network_is_online()){$(this).html()=="reading list"&&dogeared_documents_load_cache();return false}});$(".delete-document").click(function(){if(!confirm("Are you sure you want to remove this document?"))return false;var a=$(this).attr("data-document-id");
dogeared_api_call("dogeared.documents.deleteDocument",{document_id:a},function(){$("#document-"+a).remove();dogeared_feedback("Okay, that document has been removed from your reading list")})});dogeared_network_is_online()?dogeared_documents_fill_cache():dogeared_documents_load_cache()}function dogeared_documents_on_online(){console.log("local: online");$(".delete-document").removeAttr("disabled")}
function dogeared_documents_on_offline(){console.log("local: offline");$(".delete-document").attr("disabled","disabled");dogeared_documents_load_cache()}
function dogeared_documents_load_cache(){console.log("load cache");var a=dogeared_cache_documents(),b=a.length;if(b==0)return false;a.reverse();$(".excerpt").remove();$(".document").remove();var c=$("#documents"),d={};dogeared_abs_root_url();for(var e=0;e<b;e++){var f=a[e],j=f.id,l=f.title?f.title:f.url;d[j]=e;var g='<div class="row excerpt">';g+='<h3><a href="#';g+='" class="load-doc" data-document-id="';g+=htmlspecialchars(j);g+='">';g+=htmlspecialchars(l);g+="</a>";g+=" <small>offline cache</small>";
g+="</h3>";g+="<p>";g+=htmlspecialchars(f.excerpt);g+=' <a href="#" class="load-doc" data-document-id="';g+=htmlspecialchars(j);g+='">...</a></p>';g+="</div>";c.append(g)}$(".load-doc").click(function(){var m=$(this).attr("data-document-id"),k=a[d[m]],n=k.title?k.title:k.url;k=JSON.parse(k.body);var h='<div class="row document"';h+=' data-document-id="';h+=htmlspecialchars(m);h+='">';h+="<h3>";h+=htmlspecialchars(n);h+="<small>offline cache</small>";h+="</h3>";for(var o in k){h+="<p>";h+=htmlspecialchars(k[o]);
h+="</p>"}h+="</document>";$(".excerpt").remove();c.append(h);return false});dogeared_document_init()}function dogeared_documents_get_text(a){a=a.document_id;if(a=="0")return false;dogeared_api_call("dogeared.documents.getInfo",{document_id:a},function(b){dogeared_cache_documents_store(b.document)})}function dogeared_documents_store_docs(a){for(i in a)dogeared_documents_get_text(a[i])}
function dogeared_documents_fill_cache(){dogeared_api_call("dogeared.documents.getList",{},function(a){dogeared_documents_store_docs(a.documents.document)})};var current_selection="";
function dogeared_document_init(){typeof window.ontouchend=="object"?$(document).bind("selectionchange",dogeared_document_selected_selectionchange):$(document).bind("mouseup",dogeared_document_selected_mouseup);$(".delete-document").click(function(){if(!confirm("Are you sure you want to remove this document?"))return false;var a={document_id:$(this).attr("data-document-id")};dogeared_api_call("dogeared.documents.deleteDocument",a,function(){var b=dogeared_abs_root_url()+"documents/?deleted=1";location.href=
b})})}
function dogeared_document_selected_mouseup(a){console.log("on mouseup");if(a.target.nodeName=="BUTTON")dogeared_document_add_highlight();else{$(".highlight").remove();a=window.getSelection();if(a.toString()!=""){range=window.getSelection().getRangeAt(0);expandedSelRange=range.cloneRange();range.collapse(false);var b=document.createElement("div");b.innerHTML='<span class="highlight"> <button id="highlight" class="btn btn-sm">Highlight</button> </span>';for(var c=document.createDocumentFragment(),d,
e;d=b.firstChild;)e=c.appendChild(d);range.insertNode(c);if(e){expandedSelRange.setEndAfter(e.previousSibling);a.removeAllRanges();a.addRange(expandedSelRange)}}}}
function dogeared_document_selected_selectionchange(){$(".highlight").remove();var a=window.getSelection().toString();if(a!="")if(a!=current_selection){current_selection=a;range=window.getSelection().getRangeAt(0);expandedSelRange=range.cloneRange();range.collapse(false);a=document.createElement("div");a.innerHTML='<span class="highlight"> <button id="highlight" class="btn btn-sm">Highlight</button> </span>';for(var b=document.createDocumentFragment(),c;c=a.firstChild;)b.appendChild(c);range.insertNode(b);
$("#highlight").click(dogeared_document_add_highlight)}}
function dogeared_document_add_highlight(){var a=$("#document").attr("data-document-id"),b=window.getSelection();b=current_selection?current_selection:b.toString();a={document_id:a,text:b};if(dogeared_network_is_online())dogeared_api_call("dogeared.highlights.addHighlight",a,function(c){c.stat!="ok"?dogeared_feedback_api_error(c):dogeared_feedback_modal("Your highlight has been added.")});else if(dogeared_cache_highlights_store(a)){dogeared_feedback_modal("Your highlight has been cached.");dogeared_cache_highlights_status()}}
;function dogeared_highlights_init(){}function dogeared_highlights_init_list(){$(".delete-highlight").click(function(){if(!confirm("Are you sure you want to delete this highlight?"))return false;var a=$(this).attr("data-highlight-id");dogeared_api_call("dogeared.highlights.deleteHighlight",{id:a},function(){$("#highlight-"+a).remove();dogeared_feedback("That highlight has been deleted.")})})}
function dogeared_highlights_init_single(){$(".delete-highlight").click(function(){if(!confirm("Are you sure you want to delete this highlight?"))return false;var a={id:$(this).attr("data-highlight-id")};dogeared_api_call("dogeared.highlights.deleteHighlight",a,function(){var b=dogeared_abs_root_url()+"highlights/?deleted=1";location.href=b})})};var notepad_interval=null,notepad_inprocess_sync=[],notepad_pending_sync=[];function dogeared_notepad_init(){window.addEventListener("online",dogeared_notepad_on_online);dogeared_network_is_online()?dogeared_notepad_sync_list():dogeared_notepad_build_list()}function dogeared_notepad_on_online(){notepad_pending_sync.length&&dogeared_notepad_sync_notes(notepad_pending_sync)}
function dogeared_notepad_add_note(){var a=prompt("What is the title of your note?");if(!a)return false;var b=Math.uuid(),c=dogeared_now(),d=dogeared_notepad_source();a={id:b,source_id:d,created:c,lastmodified:0,deleted:0,title:a,body:"This note left intentionally blank."};b=dogeared_notepad_key(a);store.set(b,a);dogeared_notepad_load_note(b)}
function dogeared_notepad_load_note(a){var b=store.get(a),c=$("#notes-list"),d=$("#note-editor"),e=$("#note-editor-close"),f=$("#note-editor-delete");d.attr("data-note-id",a);$("#note-title").html(b.title);$("#note-body").html(b.body);e.click(function(){dogeared_notepad_close_note();return false});f.click(function(){if(!confirm("Are you sure you want to delete this note?"))return false;dogeared_notepad_delete_note();dogeared_notepad_build_list();return false});c.hide();d.show();notepad_interval=setInterval(function(){dogeared_notepad_save_note()},
5E3)}function dogeared_notepad_save_note(){if(note=dogeared_notepad_get_current_note()){var a=dogeared_notepad_key(note),b=false,c=$("#note-title");c=c.html();var d=$("#note-body");d=d.html();if(note.title!=c){note.title=c;b=true}if(note.body!=d){note.body=d;b=true}if(b){b=dogeared_now();note.lastmodified=b;console.log("update "+a);store.set(a,note);dogeared_notepad_sync_note(note)}}}
function dogeared_notepad_delete_note(){if(note=dogeared_notepad_get_current_note()){clearInterval(notepad_interval);var a=dogeared_notepad_key(note),b=dogeared_now();note.title="[redacted]";note.body="";note.deleted=b;note.lastmodified=b;console.log("delete "+a);store.set(a,note);dogeared_feedback_modal("This note has been deleted");dogeared_notepad_sync_note(note)}}
function dogeared_notepad_close_note(){notepad_interval&&clearInterval(notepad_interval);dogeared_notepad_save_note();$("#note-editor").hide();dogeared_notepad_build_list()}
function dogeared_notepad_build_list(){var a=$("#note-editor"),b=$("#notes-list"),c="";c+='<li><a href="#" id="note-add">Add a note</a></li>';store.forEach(function(d,e){if(d.split("_")[0]=="notepad"){e.id||store.remove(d);if(!parseInt(e.deleted)){var f=e.title,j=e.source_id;c+="<li>";c+='<a href="#" class="note-item" data-note-key="'+d+'">'+f+"</a> ";c+="<small>"+j+"</small>";c+="</li>"}}});b.html(c);$("#note-add").click(function(){dogeared_notepad_add_note();return false});$(".note-item").click(function(){var d=
$(this).attr("data-note-key");dogeared_notepad_load_note(d);return false});a.hide();b.show()}function dogeared_notepad_sync_list(){dogeared_feedback("Synching local documents in progress");store.forEach(function(b,c){b.split("_")[0]=="notepad"&&dogeared_notepad_sync_note(c)});var a=setInterval(function(){if(!notepad_inprocess_sync.length){dogeared_feedback_ok("Syncing local documents complete",5);clearInterval(a);dogeared_notepad_get_list()}},1E3)}
function dogeared_notepad_get_list(){dogeared_feedback("Synching remote documents in progress");dogeared_api_call("dogeared.notepad.getList",{},function(a){a=a.notes.note;for(var b=a.length,c=0;c<b;c++){var d=a[c],e=dogeared_notepad_key(d);if(!store.get(e)){console.log("add "+e);store.set(e,d)}}dogeared_feedback("Synching remote documents complete",5);dogeared_notepad_build_list()},function(){dogeared_feedback_error("Synching remote documents failed, so just loading local ones");dogeared_notepad_build_list()})}
function dogeared_notepad_sync_pending_notes(a){for(id in a){var b=dogeared_notepad_key({id:id});b=store.get(b);dogeared_notepad_sync_note(b)}}
function dogeared_notepad_sync_note(a){var b=a.id;if(!dogeared_network_is_online()){notepad_pending_sync[b]=true;return false}delete notepad_pending_sync[b];if(notepad_inprocess_sync[b]==true)return false;notepad_inprocess_sync[b]=true;a={note:JSON.stringify(a)};dogeared_api_call("dogeared.notepad.syncNote",a,function(c){c=c.note;var d=c.id,e=dogeared_notepad_key(c);store.set(e,c);notepad_inprocess_sync[d]=false},function(){notepad_inprocess_sync[b]=false})}
function dogeared_notepad_get_current_note(){var a=$("#note-editor").attr("data-note-id");if(a){var b=store.get(a);if(b)return b;else{dogeared_feedback_error("Failed to load "+a+" which is weird because I am trying to save it...");clearInterval(notepad_interval)}}else clearInterval(notepad_interval)}function dogeared_notepad_key(a){return"notepad_"+a.id}function dogeared_notepad_source(){return(new Fingerprint).get()};function dogeared_cache_count_for_type(a){var b=0;store.forEach(function(c){if(c.split("_")[0]==a)b+=1});return b}function dogeared_cache_get_for_type(a){var b=[];store.forEach(function(c,d){if(c.split("_")[0]==a){d.cache_key=c;b.push(d)}});return b};function dogeared_cache_documents_store(a){if(!store.enabled){console.log("localstorage is not enabled");return false}var b=a.lastmodified,c="dogeared_"+a.id,d=1;if(cache=store.get(c))if(cache.lastmodified>=b)d=0;d&&store.set(c,a)}function dogeared_cache_documents(){return dogeared_cache_get_for_type("dogeared")};function dogeared_cache_highlights_init(){dogeared_cache_highlights_status()}function dogeared_cache_highlights_store(a){if(!store.enabled){console.log("localstorage is not enabled");return false}var b=hex_md5(a.text);a.hash=b;b="highlight_"+b;if(cache=store.get(b))return true;store.set(b,a);return true}function dogeared_cache_highlights_remove_key(a){store.remove(a)}
function dogeared_cache_highlights_status(){var a=$("#feedback-pending-highlights"),b=dogeared_cache_count_for_type("highlight");if(b==1){var c=dogeared_abs_root_url()+"highlights/pending/";a.html('there are <a href="'+c+'">pending highlights</a>.');a.show()}else if(b){c=dogeared_abs_root_url()+"highlights/pending/";a.html('there are <a href="'+c+'">'+b+" pending highlights</a>.");a.show()}else{a.html("");a.hide()}}
function dogeared_cache_highlights(){return dogeared_cache_get_for_type("highlight")};
